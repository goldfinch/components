const u=t=>t.toString().slice(1,-1),k=u(/((?:[,\s]+(?:[a-z0-9\-_]+)=(?:(?:[a-z0-9\-_]+)|(?:\d+\.\d+)|(?:'[^']*')|(?:"[^"]*")))*)/),f=/[,\s]+([a-z0-9\-_]+)=(?:([a-z0-9\-_]+)|(\d+\.\d+)|(?:'([^']*)')|(?:"([^"]*)"))/,w=u(/\[%s/),T="\\]",_=u(/\[\s*\/\s*%s\s*]/),S=u(/((?:.|\n|)*?)/),D=u(/\s*/),y={match(t,c,i){let l=`${i18n.sprintf(w,t)}${k}${D}${T}`;c&&(l=`${l}${S}${i18n.sprintf(_,t)}`);const d=new RegExp(l,"i").exec(i);if(!d)return null;const h=this.parseProperties(d[1]);return{name:t,wrapped:c,properties:h,original:d[0],content:c?d[2]:null}},parseProperties(t){let c=t;const i={};let o=c.match(f);for(;o;){const l=o[1]||"",r=o[2]||o[3]||o[4]||o[5]||"";l&&(i[l]=r);const d=c.indexOf(o[0]);c=c.substr(d+o[0].length),o=c.match(f)}return i},serialise(t,c=!1){const i=c?{sep:",",quote:"",replacer:/[^a-z0-9\-_.]/gi}:{sep:" ",quote:'"',replacer:/"/g},o=Object.entries(t.properties).map(([l,r])=>r?`${i.sep}${l}=${i.quote}${`${r}`.replace(i.replacer,"")}${i.quote}`:null).filter(l=>l!==null).join("");return t.wrapped?`[${t.name}${o}]${t.content}[/${t.name}]`:`[${t.name}${o}]`}},v=()=>{const t=document.createElement("div");return c=>c===void 0?"":(t.textContent=c,t.innerHTML)},R=t=>{const c=v();return Object.entries(t).reduce((i,[o,l])=>({...i,[o]:c(l)}),{})},g=async function(t,c){const i=await fetch(t,{method:"POST",headers:{"X-CSRF-TOKEN":window.ss.config.SecurityID},body:c});if(!i.ok)throw new Error("Fetch request failed");return i.json()};tinymce.PluginManager.add("htmlsnippets",(t,c)=>{let i,o,l;t.addCommand("cc-delete",()=>{const e=t.selection.getNode();t.dom.is(e,b)?e.remove():t.dom.is(e.parentNode,b)?e.parentNode.remove():console.error({error:"Unexpected selection - expected embed",selectedNode:e})});const r={title:"Content Components",body:{type:"panel",items:[{type:"htmlpanel",html:"<p>Please, select type of component you would like to add</p><p></p>"},{type:"listbox",name:"component",label:"Component",enabled:!1,items:[{text:"-",value:"-"}]}]},initialData:{},buttons:[{type:"custom",name:"action_next",text:"Next",enabled:!1}],onChange:(e,n)=>{const s=e.getData();e.setEnabled("action_next",s.component)},onAction:async(e,n)=>{n.name==="action_next"&&(e.block("Loading"),C(e))}},d={title:"Content Components",body:{type:"panel",items:[{type:"htmlpanel",html:"<p>Now, select the actual component you would like to be used</p><p></p>"},{type:"listbox",name:"component",label:"Component",enabled:!1,items:[{text:"-",value:"-"}]}]},buttons:[{type:"custom",name:"action_back",text:"Back",enabled:!0},{type:"custom",name:"action_insert",text:"Insert",enabled:!1}],initialData:{},onChange:(e,n)=>{const s=e.getData();e.setEnabled("action_insert",s.component)},onAction:async(e,n)=>{if(n.name==="action_back")e.block("Loading"),h(e);else if(n.name==="action_insert"){const s=e.getData(),a=Object.keys(o).find(m=>o[m].value===i),p=Object.keys(l).find(m=>l[m].value===s.component);tinymce.activeEditor.execCommand("mceInsertContent",!1,`[htmlsnippetblock class="gf-component" data-class="${i}" data-id="${s.component}" data-bn="${o[a].text}" data-n="${l[p].text}"].[/htmlsnippetblock]`),e.close()}}},h=async e=>{const n=new FormData;n.append("name",t.targetElm.getAttribute("name")),n.append("class",t.targetElm.getAttribute("data-based-on-class"));try{const s=await g("/api-html-snippets/component/types",n),a=r;a.body.items[1].enabled=!0,a.body.items[1].items=s,o=s,e.redial(a),e.unblock()}catch{}},C=async e=>{i=e.getData().component;const n=new FormData;n.append("name",t.targetElm.getAttribute("name")),n.append("class",t.targetElm.getAttribute("data-based-on-class")),n.append("component",i);try{const s=await g("/api-html-snippets/component/objects",n);l=s;const a=d;a.body.items[1].enabled=!0,a.body.items[1].items=s,e.unblock(),e.redial(a)}catch{}};t.ui.registry.addButton("htmlsnippets",{icon:"sharpen",onAction:async()=>{const e=t.windowManager.open(r);return e.block("Loading"),h(e),e}});const b='div[data-shortcode="htmlsnippetblock"]';return t.ui.registry.addButton("ccdelete",{tooltip:"Delete content block",icon:"remove",onAction:()=>t.execCommand("cc-delete")}),t.ui.registry.addContextToolbar("htmlsnippets",{predicate:e=>t.dom.is(e,b),position:"node",scope:"node",items:"ccdelete"}),t.on("GetContent",e=>{const n=jQuery(`<div>${e.content}</div>`);n.find(b).each(function(){const a=jQuery(this),p=a.data("id"),m=a.data("class"),x=a.data("n"),O=a.data("bn"),$=R({"data-id":p,"data-class":m,"data-n":x,"data-bn":O,class:a.prop("class")}),E=y.serialise({name:"htmlsnippetblock",properties:$,wrapped:!0,content:""});a.replaceWith(E)}),e.content=n.html()}),t.on("BeforeSetContent",e=>{let{content:n}=e,s=y.match("htmlsnippetblock",!0,n);for(;s;){const a=s.properties,p=jQuery("<div/>").attr("data-id",a["data-id"]).attr("data-class",a["data-class"]).attr("data-n",a["data-n"]).attr("data-bn",a["data-bn"]).attr("data-shortcode","htmlsnippetblock").addClass(a.class);p.html('<img src="/_resources/vendor/goldfinch/html-snippets/client/dist/images/component.svg" width="">'),n=n.replace(s.original,jQuery("<div/>").append(p).html()),s=y.match("htmlsnippetblock",!0,n)}e.content=n}),{getMetadata:()=>({name:"Goldfinch Components",url:"https://github.com/goldfinch/html-snippets"})}});
