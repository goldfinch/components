const u=t=>t.toString().slice(1,-1),k=u(/((?:[,\s]+(?:[a-z0-9\-_]+)=(?:(?:[a-z0-9\-_]+)|(?:\d+\.\d+)|(?:'[^']*')|(?:"[^"]*")))*)/),f=/[,\s]+([a-z0-9\-_]+)=(?:([a-z0-9\-_]+)|(\d+\.\d+)|(?:'([^']*)')|(?:"([^"]*)"))/,w=u(/\[%s/),T="\\]",_=u(/\[\s*\/\s*%s\s*]/),S=u(/((?:.|\n|)*?)/),D=u(/\s*/),y={match(t,c,l){let r=`${i18n.sprintf(w,t)}${k}${D}${T}`;c&&(r=`${r}${S}${i18n.sprintf(_,t)}`);const d=new RegExp(r,"i").exec(l);if(!d)return null;const h=this.parseProperties(d[1]);return{name:t,wrapped:c,properties:h,original:d[0],content:c?d[2]:null}},parseProperties(t){let c=t;const l={};let a=c.match(f);for(;a;){const r=a[1]||"",i=a[2]||a[3]||a[4]||a[5]||"";r&&(l[r]=i);const d=c.indexOf(a[0]);c=c.substr(d+a[0].length),a=c.match(f)}return l},serialise(t,c=!1){const l=c?{sep:",",quote:"",replacer:/[^a-z0-9\-_.]/gi}:{sep:" ",quote:'"',replacer:/"/g},a=Object.entries(t.properties).map(([r,i])=>i?`${l.sep}${r}=${l.quote}${`${i}`.replace(l.replacer,"")}${l.quote}`:null).filter(r=>r!==null).join("");return t.wrapped?`[${t.name}${a}]${t.content}[/${t.name}]`:`[${t.name}${a}]`}},v=()=>{const t=document.createElement("div");return c=>c===void 0?"":(t.textContent=c,t.innerHTML)},R=t=>{const c=v();return Object.entries(t).reduce((l,[a,r])=>({...l,[a]:c(r)}),{})},g=async function(t,c){const l=await fetch(t,{method:"POST",headers:{"X-CSRF-TOKEN":window.ss.config.SecurityID},body:c});if(!l.ok)throw new Error("Fetch request failed");return l.json()};tinymce.PluginManager.add("htmlcomponents",(t,c)=>{let l,a,r;t.addCommand("cc-delete",()=>{const e=t.selection.getNode();t.dom.is(e,b)?e.remove():t.dom.is(e.parentNode,b)?e.parentNode.remove():console.error({error:"Unexpected selection - expected embed",selectedNode:e})});const i={title:"Content Components",body:{type:"panel",items:[{type:"htmlpanel",html:"<p>Please, select type of component you would like to add</p><p></p>"},{type:"listbox",name:"component",label:"Component",enabled:!1,items:[{text:"-",value:"-"}]}]},initialData:{},buttons:[{type:"custom",name:"action_next",text:"Next",enabled:!1}],onChange:(e,n)=>{const s=e.getData();e.setEnabled("action_next",s.component)},onAction:async(e,n)=>{n.name==="action_next"&&(e.block("Loading"),C(e))}},d={title:"Content Components",body:{type:"panel",items:[{type:"htmlpanel",html:"<p>Now, select the actual component you would like to be used</p><p></p>"},{type:"listbox",name:"component",label:"Component",enabled:!1,items:[{text:"-",value:"-"}]}]},buttons:[{type:"custom",name:"action_back",text:"Back",enabled:!0},{type:"custom",name:"action_insert",text:"Insert",enabled:!1}],initialData:{},onChange:(e,n)=>{const s=e.getData();e.setEnabled("action_insert",s.component)},onAction:async(e,n)=>{if(n.name==="action_back")e.block("Loading"),h(e);else if(n.name==="action_insert"){const s=e.getData(),o=Object.keys(a).find(p=>a[p].value===l),m=Object.keys(r).find(p=>r[p].value===s.component);tinymce.activeEditor.execCommand("mceInsertContent",!1,`[htmlcomponentblock class="gf-component" data-class="${l}" data-id="${s.component}" data-bn="${a[o].text}" data-n="${r[m].text}"].[/htmlcomponentblock]`),e.close()}}},h=async e=>{const n=new FormData;n.append("name",t.targetElm.getAttribute("name")),n.append("class",t.targetElm.getAttribute("data-based-on-class"));try{const s=await g("/api-html-components/component/types",n),o=i;o.body.items[1].enabled=!0,o.body.items[1].items=s,a=s,e.redial(o),e.unblock()}catch{}},C=async e=>{l=e.getData().component;const n=new FormData;n.append("name",t.targetElm.getAttribute("name")),n.append("class",t.targetElm.getAttribute("data-based-on-class")),n.append("component",l);try{const s=await g("/api-html-components/component/objects",n);r=s;const o=d;o.body.items[1].enabled=!0,o.body.items[1].items=s,e.unblock(),e.redial(o)}catch{}};t.ui.registry.addButton("htmlcomponents",{icon:"sharpen",onAction:async()=>{const e=t.windowManager.open(i);return e.block("Loading"),h(e),e}});const b='div[data-shortcode="htmlcomponentblock"]';return t.ui.registry.addButton("ccdelete",{tooltip:"Delete content block",icon:"remove",onAction:()=>t.execCommand("cc-delete")}),t.ui.registry.addContextToolbar("htmlcomponents",{predicate:e=>t.dom.is(e,b),position:"node",scope:"node",items:"ccdelete"}),t.on("GetContent",e=>{const n=jQuery(`<div>${e.content}</div>`);n.find(b).each(function(){const o=jQuery(this),m=o.data("id"),p=o.data("class"),x=o.data("n"),O=o.data("bn"),$=R({"data-id":m,"data-class":p,"data-n":x,"data-bn":O,class:o.prop("class")}),E=y.serialise({name:"htmlcomponentblock",properties:$,wrapped:!0,content:""});o.replaceWith(E)}),e.content=n.html()}),t.on("BeforeSetContent",e=>{let{content:n}=e,s=y.match("htmlcomponentblock",!0,n);for(;s;){const o=s.properties,m=jQuery("<div/>").attr("data-id",o["data-id"]).attr("data-class",o["data-class"]).attr("data-n",o["data-n"]).attr("data-bn",o["data-bn"]).attr("data-shortcode","htmlcomponentblock").addClass(o.class);m.html('<img src="/_resources/vendor/goldfinch/html-components/client/dist/images/component.svg" width="">'),n=n.replace(s.original,jQuery("<div/>").append(m).html()),s=y.match("htmlcomponentblock",!0,n)}e.content=n}),{getMetadata:()=>({name:"Goldfinch Components",url:"https://github.com/goldfinch/html-components"})}});
